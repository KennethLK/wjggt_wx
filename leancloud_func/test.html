<html>
<head>
<meta charset="UTF-8">
<title>Test for Guofu</title>
	<!-- 存储服务 -->
	<script src="https://cdn1.lncld.net/static/js/av-min-1.5.3.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.1.1/jquery.min.js"></script>
<style type="text/css">
	* {font-size: 16;}
</style>
</head>
<body>
<script>

// 线上的
// var APP_ID = 'zgOwiJsyN5DXaRr0q7PBa45n-gzGzoHsz';
// var APP_KEY = 'ayYlvpO6eIKa2OOuqrWY91iG';
        var APP_ID = 'rdBRaWlAUDRbABMzwAsGCG11-gzGzoHsz';

        var APP_KEY = 'vU4Fm7XYX0TpHTNBAMPILbFp';

AV.init({
	appId: APP_ID,
	appKey: APP_KEY	
});

var user = {};

</script>

<Button onclick="javascript:saveConsume()">保存消费记录</Button><br /><br />

餐馆名称 <Input type="text" id="restaurantName" value="" style="width: 150" /><br />
选择已有餐馆<div id="restaurantContainer" >
	<input type="radio" name="restaurant" value="0" > 其他 <br >
</div><br />
<Button onclick="javascript:loadRestaurant()">加载餐馆</Button><br />
消费金额 <Input type="text" id="amount" value="" style="width: 150" /><br />
消费时间 <Input type="text" id="date" value="2017-6-2" style="width: 150" /><br />
选择用餐人员: <div id="consumerContainer" >
</div><br />
<Button onclick="javascript:loadConsumer()">加载队员</Button><br />

<Input type="text" id="uid" value="592456f28d6d810058fad1c2" style="width: 450"/>
<Button onclick="javascript:loadRecentConsume()">得到最近10天我的消费明细</Button><br /><br />
<div Id="consumeDetailContainer"> </div>
<Button onclick="javascript: getCheckedItems()">选择的项目</Button>

<script type="text/javascript">

function saveConsume()
{
	var consumers = getConsumers();
	var resObj= getRestaurant();
	var amount = parseInt($("#amount").val());
	var date = Date.parse($("#date").val());
	// if (isNaN(amount) || amount == 0)
	// {
	// 	amount = Math.random((new Date().getMilliseconds())) * 50 + 80;
	// 	amount = Math.ceil(amount);
	// }

	var validDateBase1 = Date.parse('2017-5-1')
	var validDateBase2 = Date.parse('2018-5-1')

	var resId, resName;
	resId = resObj.id;
	resName = resObj.name;
	
	if (isNaN(amount) || amount < 1){
		alert("金额不对")
		return;
	}

	if (resId == undefined && resName == ""){
		alert("餐馆不对");
		return;
	}

	if (date < validDateBase1 || date > validDateBase2)
	{
		alert("时间不对呢");
		return;
	}

	if (consumers.length == 0)
	{
		alert("吃饭的人呢")
		return;
	}

	var q = {};
		q.name = resName;
	if (resId != undefined)
	{
		q.resId = resId;
	}
	q.date = date;
	q.amount = amount;
	q.consumers = consumers;
	q.recorderId = "592456f28d6d810058fad1c2";
	q.groupId = "592ff945fe88c2006192a118";

	AV.Cloud.run('saveConsume', q).then(function(rec){
		alert('save success');
	}).catch(function(error){
		alert('error:' + error.message);
	})
}

function getCheckedItems()
{
	//选中的餐馆
	var resObj = getRestaurant();
	alert("name: " + resObj.name);
	alert("id:" + resObj.id);
	//选中的食客
	var consumers = getConsumers();
	alert(consumers.length);
}

function getRestaurant()
{
	var got = false;
	var restaurant;
	var resId;
	var restaurants = $("input[name='restaurant'").each(function(){
		if ($(this).prop("checked"))
		{
			got = true;
			resId = $(this).val();
		}
	});

	if (!got)
	{
		restaurant = $("#restaurantName").val();
	}

	if(resId == "0"){
		resId = undefined;
	}

	return {"name": restaurant, "id": resId};
}

function getConsumers()
{
	var consumers = [];
	var restaurants = $("input[name='consumer'").each(function(){
		if ($(this).prop("checked"))
		{
			consumers.push($(this).val());
		}
	});

	return consumers;
}

function loadRestaurant()
{
	var ele = $('#restaurantContainer');
	var q = new AV.Query('WJRestaurant');
	q.find().then(function(reses){
		reses.forEach(function(res){
			var box = document.createElement('input');
			box.setAttribute("type", "radio");
			box.setAttribute("value", res.id);
			box.setAttribute("name", "restaurant");
			box.setAttribute("id", "restaurant");
			ele.append(box);
			ele.append(res.get('name'));
			ele.append($("<br />"));
		});
	});
}

function loadConsumer()
{
	var ele = $('#consumerContainer');
	var q = new AV.Query('WJUser');
	q.notEqualTo('isHuman', false);
	q.find().then(function(reses){
		reses.forEach(function(res){

			var box = document.createElement('input');
			box.setAttribute("type", "checkbox");
			box.setAttribute("value", res.id);
			box.setAttribute("name", "consumer");
			box.setAttribute("id", "consumer");
			ele.append(box);
			ele.append(res.get('name'));
			ele.append($("<br />"));
		});
	});
}

function loadRecentConsume()
{

var q = new AV.Query('WJGroup');
q.equalTo('authCode', "5007");
q.first(function (group){
	if (group == undefined){
		console.log("group not found");
		return;
	}
	grp = group
	console.log("group found:" + group.id);
	var q = new AV.Query('WJUser');
	q.get("593d5487da2f600067248fe22").then(function(tuser){
		tuser.set('group', group);
		tuser.save().then(function(user){
			console.log("saved");
		}, function (error){

			console.log('save error' + error.message + ";group id: " + group.get("objectId"));
		})
	}).catch(function(error){
		console.log('find user error' + error.message);
	});
}, function(error){
	console.log("find group error: " + error.message);
});

return;
	var uid = $("#uid").val();
	var q0 = new AV.Query('WJCash');
	var usr = AV.Object.createWithoutData('WJUser', uid);
	var infos = [];
	q0.equalTo('user', usr);
	q0.include('consume');
	q0.include('user');
	q0.limit(20);
	q0.find().then(function(details){
		details.forEach(function(detail){
			var consume = detail.get("consume");
			var cname = consume.get('name');
			var pa = detail.get('cash');
			var ca = consume.get('amount');
			var pr = consume.get("peopleAmount");
			var da = detail.get("date");
			var dd = da.getDay();
			var info = "<p>时间: " + da.toLocaleString() + "[" + getDayName(dd) + "]" + ";餐馆:" + cname + ";消费金额: " + ca + "; 个人消费:" + pa + ";消费人数: " + pr + "</p>";
			$("#consumeDetailContainer").append(info);
		});
	}).catch(function(error){
		alert('error:' + error.message);
	});
}

function getDayName(day){
	var names = ["星期天", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
	return names[day];
}

function saveConsumeDetail()
{
	var consumers = ["5924eb2ea22b9d0058a208dc", "592500eca0bb9f005f7d7cb5","592501152f301e006b3692e6"]; //消费人列表, 数组
	var consumeId = "59301daa0ce4630057ebb381"; //消费id, 字符串
	var amount = 10; //人均后的钱钱, 数字
	var recorderId = "592456f28d6d810058fad1c2"; //录入人
	var time = 1496324843225; //1970的毫秒数, 数字

	var allCash = [];
	var date = new Date();
	date.setTime(time);
	console.log("date:" + date);
	var recorder = AV.Object.createWithoutData('WJUser', recorderId);
	console.log("recorderId:" + recorderId);
	var consume = AV.Object.createWithoutData('WJConsume',consumeId);
	console.log("consumeId:" + consumeId);

	var qs = new AV.Query('WJUser');
	qs.equalTo('objectId', "123");
	for (var i = consumers.length - 1; i >= 0; i--) {
		var uid = consumers[i];
		var cash = amount;
		var usr = AV.Object.createWithoutData('WJUser', uid);
		var ca = new AV.Object('WJCash');
		ca.set('consume', consume);
		ca.set('type', 1);
		ca.set('user', usr);
		ca.set('recorder', recorder);
		ca.set('cash', cash);
		ca.set('date', date);
		allCash.push(ca);
		console.log("add a record; user: " + consumers[i] + ";");

		// var q = AV.Object.createWithoutData('WJUser', uid);
		// qs.push(q);

		var q = new AV.Query('WJUser');
		q.equalTo('objectId', uid);
		
		var q2 = AV.Query.or(q, qs);
		qs = q2;
	}

	qs.find().then(function(users){
		console.log('获取到用户:' + users.length);
		users.forEach(function(result){
			var balance = result.get('cash');
			console.log("balance: " + balance);
	        balance += amount;
	        result.set('cash', balance);
			console.log("balance: " + balance);
		});
		return 1;
	}).then(function(users){
		console.log('扣款:' + users);
		return AV.Object.saveAll(allCash);
	}).then(function(){
		console.log('记录已保存');
		response.success("扣款成功");
	}).catch(function(error){
		console.log('发生错误了:' + error);
		response.error('save cash error ' + error.message);
	});
}

</script>
</body>
</html>